# 新增功能说明

## 功能1：智能低头找头 ⭐

### 功能描述
当检测到**人体躯体但没检测到头部**时，系统会自动**向下移动摄像头**（低头），尝试寻找头部。搜索期间**水平方向继续跟踪**，不受影响。

### 触发条件
```
✅ 检测到人体（all_detections 不为空）
❌ 没检测到头部（head_center 为 None）
⏱️ 持续 5 帧（约 0.6 秒）
```

### 工作流程

```
1. 检测到身体但没头部
   ↓
2. 等待 5 帧确认
   ↓
3. 开始低头搜索（每次 0.05 弧度 ≈ 2.9°）
   ↓
4a. 找到头部 → 停止搜索，继续正常跟踪
   ↓
4b. 达到最大步数（8步）→ 回到原位置（抬回）
```

### 关键特性
- ⚠️ **水平方向不受影响**：`yaw=0`，只改变 `pitch`
- 📏 搜索范围：8 × 0.05 = **0.4 弧度 ≈ 22.9°**
- 🔄 自动回位：没找到头部会自动抬回原位置

### 运行示例

**成功找到头部：**
```
🎯 目标1 | rel=(0.01, -0.72) | conf=0.88
⚠️  检测到 1 人但没有头部 - 可能需要低头搜索
⚠️  检测到 1 人但没有头部 - 可能需要低头搜索
...
🔍 开始低头搜索头部...
🔍 低头搜索 1/8...
🔍 低头搜索 2/8...
✅ 低头搜索成功找到头部！
🎯 目标1 | rel=(0.02, -0.65) | conf=0.91
```

**未找到头部：**
```
🔍 开始低头搜索头部...
🔍 低头搜索 1/8...
🔍 低头搜索 2/8...
...
🔍 低头搜索 8/8...
❌ 未找到头部，回到原位置（抬头 0.400rad）
```

---

## 功能2：超时回到零点 ⏰

### 功能描述
当**连续 3 秒检测不到人**时，电机自动回到零位（水平+垂直都归零）。

### 触发条件
```
⏱️ 超过 3 秒没有检测到任何人
```

### 工作流程

```
1. 正常跟踪中...
   ↓
2. 人离开画面/被遮挡
   ↓
3. 开始计时...
   ↓
4a. 3秒内重新检测到人 → 继续跟踪
   ↓
4b. 超过3秒无人 → 电机回到零位 (0, 0)
```

### 关键特性
- ⏱️ 超时阈值：3 秒（可调）
- 🔄 双轴归零：水平 + 垂直都回到 0
- 📊 统计记录：记录超时回零次数

### 运行示例

```
🎯 目标1 | rel=(0.01, -0.72) | conf=0.88  ← 正常跟踪
...（人离开画面）
⚠️  目标丢失 (1/10)
⚠️  目标丢失 (2/10)
...
⚠️  目标丢失 (10/10)
🔄 目标丢失超过10帧，回到零位
⏰ 超过 3.0 秒未检测到人，回到零点  ← 超时回零
```

---

## 参数配置

### 在命令行中配置

```bash
python3 bidirectional_tracking.py \
    --coords tracker_coords.json \
    --serial /dev/ttyS8 \
    --baudrate 115200 \
    --max-no-head-frames 5 \      # 多少帧没头才触发搜索
    --max-search-steps 8 \       # 最多低头多少步
    --search-pitch 0.05 \        # 每步低头角度（正值=低头）
    --timeout-seconds 3.0       # 超时多少秒回零
```

### 参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--max-no-head-frames` | 5 | 连续多少帧没检测到头才触发搜索 |
| `--max-search-steps` | 8 | 最大搜索步数 |
| `--search-pitch` | 0.05 | 每步低头角度（正值=低头，负值=抬头） |
| `--timeout-seconds` | 3.0 | 超时阈值（秒） |

---

## 水平方向不受影响

### 搜索期间只改变俯仰角

```python
# 正常跟踪
yaw_delta = -0.05, pitch_delta = 0.03  # 双轴都动

# 搜索期间
yaw_delta = 0, pitch_delta = 0.05       # ⚠️ yaw=0，保持水平方向
```

### 实际效果

```
搜索前：
  水平: 向左转 0.05 rad
  垂直: 向下转 0.03 rad

搜索中（低头找头）：
  水平: ✅ 继续跟踪（向左/右）
  垂直: ⬇️ 低头 0.05 rad/步
```

---

## 完整工作流程

### 正常跟踪

```
检测到头部 → 计算偏移 → 发送电机命令 → 电机转动
```

### 场景1：身体没头部（低头搜索）

```
检测到身体 → 等待5帧 → 开始低头搜索
                              ↓
                         只改变pitch（yaw=0）
                              ↓
                    找到头 → 继续跟踪
                    没找到 → 抬回原位
```

### 场景2：人离开（超时回零）

```
人离开 → 开始计时 → 3秒无人 → 电机回零点 (0, 0)
```

---

## 统计信息

程序结束时会显示：

```
============================================================
📊 双向跟踪统计
============================================================
总更新次数: 1234

水平方向:
  向左移动: 45
  向右移动: 38

垂直方向:
  向上移动: 67
  向下移动: 52

其他:
  保持位置: 234
   丢失帧数: 15
  回到零位: 3 次

智能低头搜索:
  触发次数: 12
  成功找到头: 10
  成功率: 83.3%

超时回到零点:
  超时重置次数: 5 次
  超时阈值: 3.0 秒

错误次数: 0
============================================================
```

---

## 使用场景

### ✅ 适用场景

1. **人坐着，摄像头角度过高**
   - 检测到身体但头部在画面外
   - 低头搜索可以找到头部

2. **人距离变化**
   - 人从远处走近
   - 头部位置变化

3. **人短暂离开**
   - 人暂时离开画面
   - 3秒后自动回零位

### ❌ 不适用场景

1. **人完全在画面外**
   - 没有身体检测
   - 需要手动调整

2. **硬件限位**
   - 搜索角度超过电机限位
   - 需要调整 `--search-pitch` 或 `--max-search-steps`

---

## 调试和优化

### 增加搜索范围

```bash
--max-search-steps 12 \      # 增加步数
--search-pitch 0.08         # 增加每步角度
# 总搜索: 12 × 0.08 = 0.96 弧度 ≈ 55°
```

### 调整超时时间

```bash
# 更快回零（1.5秒）
--timeout-seconds 1.5

# 更慢回零（5秒）
--timeout-seconds 5.0
```

### 提高灵敏度

```bash
# 更快触发搜索（3帧）
--max-no-head-frames 3

# 更快检测丢失（5帧）
--max-lost-frames 5
```

---

## 与原有功能的配合

| 功能 | 触发条件 | 动作 | 水平 | 垂直 |
|------|---------|------|------|------|
| **正常跟踪** | 有头部 | 跟随目标 | ✅ | ✅ |
| **低头搜索** | 身体没头 | 低头找头 | ❌ 保持 | ✅ 低头 |
| **超时回零** | 3秒无人 | 回到零位 | ✅ | ✅ |

---

## 注意事项

1. **搜索期间延迟**
   - 每步等待 0.2 秒
   - 8步约需 1.6 秒
   - 期间暂停正常跟踪

2. **电机限位**
   - 确保电机限位允许低头角度
   - 0.4 弧度 ≈ 23°
   - 根据实际硬件调整

3. **性能影响**
   - 搜索会暂停正常跟踪
   - 建议设置合理的触发阈值
   - 避免频繁触发

4. **超时检测**
   - 每 10 次更新检查一次
   - 约 1.25 秒检查一次（8Hz 更新频率）
