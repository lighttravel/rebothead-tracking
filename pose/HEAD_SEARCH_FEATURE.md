# 智能抬头找头功能说明

## 功能概述

当系统检测到人体但**没有检测到头部**时，会自动触发**智能抬头搜索**功能，逐步抬升摄像头视角，尝试寻找头部。

## 触发条件

```
✅ 检测到人体（all_detections 不为空）
❌ 没检测到头部（head_center 为 None）
⏱️ 持续 5 帧（约 0.6 秒）
```

## 工作流程

```
1. 检测到身体但没头部
   ↓
2. 等待 5 帧确认（避免误触发）
   ↓
3. 记录当前俯仰角度
   ↓
4. 开始抬头搜索（每次 -0.05 弧度）
   ↓
5a. 找到头部 → 停止搜索，继续跟踪
   ↓
5b. 达到最大步数（10步）→ 回到原位置，放弃搜索
```

## 参数配置

### 在 `bidirectional_tracking.py` 中可调参数：

```bash
# 触发条件
--max-no-head-frames 5        # 连续多少帧没检测到头才触发（默认：5）

# 搜索行为
--max-search-steps 10        # 最大搜索步数（默认：10）
--search-pitch -0.05         # 每次抬头角度（弧度，负值=抬头，默认：-0.05）
```

### 参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--max-no-head-frames` | 5 | 连续多少帧没检测到头才触发搜索（避免误触发） |
| `--max-search-steps` | 10 | 最多抬头多少步（每步 0.05 弧度 ≈ 2.86°） |
| `--search-pitch` | -0.05 | 每步抬头角度（负值=抬头，正值=低头） |

**总抬头角度** = `max_search_steps × search_pitch`
- 默认：10 × (-0.05) = **-0.5 弧度 ≈ -28.6°**

## 工作示例

### 场景 1：成功找到头部

```
🎯 目标1 | rel=(0.01, -0.72) | conf=0.88  ← 正常跟踪
⚠️  检测到 1 人但没有头部 - 可能需要抬头搜索
⚠️  检测到 1 人但没有头部 - 可能需要抬头搜索
⚠️  检测到 1 人但没有头部 - 可能需要抬头搜索
⚠️  检测到 1 人但没有头部 - 可能需要抬头搜索
⚠️  检测到 1 人但没有头部 - 可能需要抬头搜索
🔍 开始抬头搜索头部...
🔍 抬头搜索 1/10...
🔍 抬头搜索 2/10...
✅ 抬头搜索成功找到头部！
🎯 目标1 | rel=(0.02, -0.65) | conf=0.91  ← 继续跟踪
```

### 场景 2：未找到头部，回到原位

```
🔍 开始抬头搜索头部...
🔍 抬头搜索 1/10...
🔍 抬头搜索 2/10...
🔍 抬头搜索 3/10...
...
🔍 抬头搜索 10/10...
❌ 未找到头部，回到原位置（低头 0.500rad）
```

## 实际应用场景

### ✅ 适用场景

1. **人体被部分遮挡**
   - 用户只露出上半身，头部在画面外
   - 通过抬升摄像头，可以看到完整头部

2. **用户距离较远**
   - 初始摄像头角度过低
   - 抬头后可以更好地看到用户面部

3. **坐姿/站姿变化**
   - 用户从站立变为坐下
   - 头部位置降低，需要调整摄像头

### ❌ 不适用场景

1. **人体完全在画面外**
   - 抬头也无法找到人
   - 应该通过目标丢失机制处理

2. **人体背对摄像头**
   - 姿态估计无法检测背对的人头
   - 抬头也无法解决

## 与其他功能的配合

### 与目标丢失的区别

| 状态 | 检测到身体 | 检测到头部 | 处理方式 |
|------|----------|----------|---------|
| 正常跟踪 | ✅ | ✅ | 正常电机控制 |
| 智能抬头搜索 | ✅ | ❌ | **抬头尝试找头** |
| 目标丢失 | ❌ | ❌ | 回到零位，等待重新出现 |

### 与电机控制的配合

- **抬头搜索**只影响**俯仰轴（电机22）**
- **偏航轴（电机21）**继续正常跟踪
- 找到头部后，**双轴恢复正常跟踪**

## 调试和监控

### 终端输出

```bash
# 检测到身体但没头部
⚠️  检测到 1 人但没有头部 - 可能需要抬头搜索

# 触发搜索
🔍 开始抬头搜索头部...
🔍 抬头搜索 1/10...
🔍 抬头搜索 2/10...

# 成功找到
✅ 抬头搜索成功找到头部！

# 失败
❌ 未找到头部，回到原位置（低头 0.500rad）
```

### 统计信息

```bash
📊 双向跟踪统计
============================================================
智能抬头搜索:
  触发次数: 15
  成功找到头: 12
  成功率: 80.0%
============================================================
```

## 参数调优建议

### 提高成功率

1. **增加搜索步数**（如果摄像头限位允许）
   ```bash
   --max-search-steps 15  # 抬头 0.75 弧度 ≈ 43°
   ```

2. **增加每步角度**（更快搜索，但可能不够精细）
   ```bash
   --search-pitch -0.08  # 每步抬头 4.6°
   ```

3. **减少触发延迟**（更快响应）
   ```bash
   --max-no-head-frames 3  # 3 帧后触发（约 0.4 秒）
   ```

### 避免误触发

1. **增加触发延迟**（更稳定）
   ```bash
   --max-no-head-frames 10  # 10 帧后触发（约 1.2 秒）
   ```

2. **减少搜索步数**（避免过度抬头）
   ```bash
   --max-search-steps 5  # 只抬头 5 步
   ```

## 禁用功能

如果不需要智能抬头搜索，可以设置极小的搜索步数：

```bash
--max-search-steps 0  # 禁用抬头搜索
```

## 注意事项

1. **电机限位**
   - 确保电机限位允许抬头到搜索角度
   - 避免机械碰撞

2. **搜索角度**
   - 总抬头角度 = `max_search_steps × abs(search_pitch)`
   - 默认 10 × 0.05 = 0.5 弧度 ≈ 28.6°
   - 根据实际应用调整

3. **响应时间**
   - 搜索过程 = `max_search_steps × 0.2秒`（每次等待 0.2 秒）
   - 默认约 2 秒完成全部搜索

4. **性能影响**
   - 搜索期间会暂停正常跟踪
   - 建议设置合理的触发阈值
